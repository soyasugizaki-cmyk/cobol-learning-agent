# COBOLのプログラム構造

## 概要

COBOLプログラムは、4つのDIVISION（区分）で構成される構造化された言語です。各DIVISIONは特定の役割を持ち、プログラムの可読性と保守性を高めています。

## プログラムの基本構造

### 全体構造
```cobol
       IDENTIFICATION DIVISION.
       PROGRAM-ID. SAMPLE-PROGRAM.
       
       ENVIRONMENT DIVISION.
       
       DATA DIVISION.
       
       PROCEDURE DIVISION.
       
       MAIN-LOGIC.
           PERFORM INITIALIZATION
           PERFORM MAIN-PROCESSING
           PERFORM FINALIZATION
           STOP RUN.
```

## IDENTIFICATION DIVISION

### 目的
プログラムの識別情報を定義する区分です。プログラム名、作成者、作成日などのメタデータを含みます。

### 必須項目
```cobol
       IDENTIFICATION DIVISION.
       PROGRAM-ID. CUSTOMER-PROCESSING.
       AUTHOR.     JOHN DOE.
       DATE-WRITTEN. 2024-01-15.
       DATE-COMPILED. 2024-01-15.
       SECURITY.   CONFIDENTIAL.
```

### オプション項目
```cobol
       IDENTIFICATION DIVISION.
       PROGRAM-ID. INVENTORY-SYSTEM.
       AUTHOR.     JANE SMITH.
       INSTALLATION. MAIN-OFFICE.
       DATE-WRITTEN. 2024-01-15.
       DATE-COMPILED. 2024-01-15.
       SECURITY.   INTERNAL-USE.
       REMARKS.    在庫管理システム.
```

## ENVIRONMENT DIVISION

### 目的
プログラムの実行環境を定義する区分です。入出力デバイス、ファイルの物理的な配置、特殊なハードウェア要件などを指定します。

### CONFIGURATION SECTION
```cobol
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. IBM-3090.
       OBJECT-COMPUTER. IBM-3090.
       SPECIAL-NAMES.
           DECIMAL-POINT IS COMMA.
```

### INPUT-OUTPUT SECTION
```cobol
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT INPUT-FILE ASSIGN TO "input.dat"
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE  IS SEQUENTIAL
               FILE STATUS  IS WS-INPUT-STATUS.
               
           SELECT OUTPUT-FILE ASSIGN TO "output.dat"
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE  IS SEQUENTIAL
               FILE STATUS  IS WS-OUTPUT-STATUS.
```

## DATA DIVISION

### 目的
プログラムで使用するデータの構造と属性を定義する区分です。ファイルレコード、作業用データ、パラメータなどを定義します。

### FILE SECTION
```cobol
       DATA DIVISION.
       FILE SECTION.
       FD  INPUT-FILE
           RECORD CONTAINS 80 CHARACTERS
           RECORDING MODE IS FIXED.
       01  INPUT-RECORD.
           05  IN-CUSTOMER-ID    PIC 9(8).
           05  IN-CUSTOMER-NAME  PIC X(30).
           05  IN-AMOUNT         PIC 9(7)V99.
           05  FILLER            PIC X(33).

       FD  OUTPUT-FILE
           RECORD CONTAINS 100 CHARACTERS
           RECORDING MODE IS FIXED.
       01  OUTPUT-RECORD.
           05  OUT-CUSTOMER-ID   PIC 9(8).
           05  OUT-CUSTOMER-NAME PIC X(30).
           05  OUT-AMOUNT        PIC 9(7)V99.
           05  OUT-CALC-AMOUNT   PIC 9(7)V99.
           05  FILLER            PIC X(47).
```

### WORKING-STORAGE SECTION
```cobol
       WORKING-STORAGE SECTION.
       01  WS-WORKING-VARIABLES.
           05  WS-EOF            PIC X VALUE "N".
               88  WS-END-OF-FILE VALUE "Y".
           05  WS-RECORD-COUNT   PIC 9(6) VALUE ZERO.
           05  WS-TOTAL-AMOUNT   PIC 9(9)V99 VALUE ZERO.
           05  WS-AVERAGE-AMOUNT PIC 9(7)V99 VALUE ZERO.

       01  WS-DATE-TIME.
           05  WS-CURRENT-DATE   PIC 9(8).
           05  WS-CURRENT-TIME   PIC 9(6).
           05  WS-FORMATTED-DATE PIC X(10).

       01  WS-ERROR-FLAGS.
           05  WS-FILE-ERROR     PIC X VALUE "N".
           05  WS-DATA-ERROR     PIC X VALUE "N".
           05  WS-CALC-ERROR     PIC X VALUE "N".
```

### LINKAGE SECTION
```cobol
       LINKAGE SECTION.
       01  LS-PARAMETERS.
           05  LS-PROCESS-DATE   PIC 9(8).
           05  LS-PROCESS-TYPE   PIC X(10).
           05  LS-OUTPUT-FORMAT  PIC X(5).

       01  LS-RETURN-CODE       PIC 9(4).
           88  LS-SUCCESS        VALUE 0000.
           88  LS-FILE-ERROR     VALUE 1000.
           88  LS-DATA-ERROR     VALUE 2000.
           88  LS-SYSTEM-ERROR   VALUE 9999.
```

## PROCEDURE DIVISION

### 目的
プログラムの実際の処理ロジックを記述する区分です。ビジネスロジック、データ処理、エラーハンドリングなどを実装します。

### メインロジック
```cobol
       PROCEDURE DIVISION USING LS-PARAMETERS
                                RETURNING LS-RETURN-CODE.
       
       MAIN-LOGIC.
           PERFORM INITIALIZATION
           PERFORM MAIN-PROCESSING
           PERFORM FINALIZATION
           GOBACK.
```

### 初期化処理
```cobol
       INITIALIZATION.
           *> パラメータの検証
           IF LS-PROCESS-DATE = ZERO
               MOVE 2000 TO LS-RETURN-CODE
               GOBACK
           END-IF
           
           *> ファイルのオープン
           PERFORM OPEN-FILES
           IF WS-FILE-ERROR = "Y"
               MOVE 1000 TO LS-RETURN-CODE
               GOBACK
           END-IF
           
           *> 作業変数の初期化
           MOVE ZERO TO WS-RECORD-COUNT
           MOVE ZERO TO WS-TOTAL-AMOUNT
           MOVE "N" TO WS-EOF.
```

### メイン処理
```cobol
       MAIN-PROCESSING.
           *> ファイル終端まで処理
           PERFORM UNTIL WS-END-OF-FILE
               READ INPUT-FILE
                   AT END
                       MOVE "Y" TO WS-EOF
                   NOT AT END
                       PERFORM PROCESS-RECORD
               END-READ
               
               *> エラーチェック
               IF WS-INPUT-STATUS NOT = "00" AND WS-INPUT-STATUS NOT = "10"
                   PERFORM ERROR-HANDLING
               END-IF
           END-PERFORM.
```

### 個別レコード処理
```cobol
       PROCESS-RECORD.
           *> データの検証
           PERFORM VALIDATE-RECORD
           IF WS-DATA-ERROR = "Y"
               PERFORM LOG-ERROR-RECORD
               EXIT PARAGRAPH
           END-IF
           
           *> ビジネスロジックの実行
           PERFORM BUSINESS-LOGIC
           
           *> 出力ファイルへの書き込み
           PERFORM WRITE-OUTPUT-RECORD
           
           *> 統計情報の更新
           ADD 1 TO WS-RECORD-COUNT
           ADD IN-AMOUNT TO WS-TOTAL-AMOUNT.
```

### エラーハンドリング
```cobol
       ERROR-HANDLING.
           EVALUATE WS-INPUT-STATUS
               WHEN "30"
                   DISPLAY "ファイルが存在しません"
                   MOVE "Y" TO WS-FILE-ERROR
               WHEN "41"
                   DISPLAY "ファイルが既にオープンされています"
                   MOVE "Y" TO WS-FILE-ERROR
               WHEN OTHER
                   DISPLAY "予期しないエラー: " WS-INPUT-STATUS
                   MOVE "Y" TO WS-FILE-ERROR
           END-EVALUATE.
```

### 終了処理
```cobol
       FINALIZATION.
           *> 統計情報の表示
           PERFORM DISPLAY-STATISTICS
           
           *> ファイルのクローズ
           PERFORM CLOSE-FILES
           
           *> 正常終了の設定
           MOVE 0000 TO LS-RETURN-CODE.
```

## サブルーチンとモジュール化

### サブルーチンの定義
```cobol
       VALIDATE-RECORD.
           *> 顧客IDの検証
           IF IN-CUSTOMER-ID = ZERO
               MOVE "Y" TO WS-DATA-ERROR
               EXIT PARAGRAPH
           END-IF
           
           *> 顧客名の検証
           IF IN-CUSTOMER-NAME = SPACES
               MOVE "Y" TO WS-DATA-ERROR
               EXIT PARAGRAPH
           END-IF
           
           *> 金額の検証
           IF IN-AMOUNT NOT NUMERIC OR IN-AMOUNT < 0
               MOVE "Y" TO WS-DATA-ERROR
               EXIT PARAGRAPH
           END-IF.
```

### パラメータ付きサブルーチン
```cobol
       CALCULATE-AMOUNT USING WS-INPUT-AMOUNT
                               WS-TAX-RATE
                               RETURNING WS-OUTPUT-AMOUNT.
       
       CALCULATE-AMOUNT.
           COMPUTE WS-OUTPUT-AMOUNT = WS-INPUT-AMOUNT * (1 + WS-TAX-RATE)
               ON SIZE ERROR
                   DISPLAY "計算エラー: 桁あふれ"
                   MOVE 0 TO WS-OUTPUT-AMOUNT
               ON ZERO DIVIDE
                   DISPLAY "計算エラー: ゼロ除算"
                   MOVE 0 TO WS-OUTPUT-AMOUNT
           END-COMPUTE.
```

## 制御構造

### 条件分岐
```cobol
           *> IF-ELSE文
           IF WS-AMOUNT > 10000
               PERFORM HIGH-AMOUNT-PROCESSING
           ELSE IF WS-AMOUNT > 1000
               PERFORM MEDIUM-AMOUNT-PROCESSING
           ELSE
               PERFORM LOW-AMOUNT-PROCESSING
           END-IF
           
           *> EVALUATE文
           EVALUATE WS-PROCESS-TYPE
               WHEN "DAILY"
                   PERFORM DAILY-PROCESSING
               WHEN "WEEKLY"
                   PERFORM WEEKLY-PROCESSING
               WHEN "MONTHLY"
                   PERFORM MONTHLY-PROCESSING
               WHEN OTHER
                   PERFORM DEFAULT-PROCESSING
           END-EVALUATE
```

### ループ処理
```cobol
           *> PERFORM UNTIL
           PERFORM UNTIL WS-EOF = "Y"
               READ INPUT-FILE
                   AT END MOVE "Y" TO WS-EOF
                   NOT AT END PERFORM PROCESS-RECORD
               END-READ
           END-PERFORM
           
           *> PERFORM VARYING
           PERFORM VARYING WS-INDEX FROM 1 BY 1
               UNTIL WS-INDEX > WS-MAX-COUNT
               PERFORM PROCESS-ARRAY-ELEMENT
           END-PERFORM
           
           *> PERFORM TIMES
           PERFORM PROCESS-BATCH 5 TIMES
```

## エラー処理とログ

### エラーログの記録
```cobol
       LOG-ERROR-RECORD.
           *> エラー情報の記録
           MOVE FUNCTION CURRENT-DATE TO WS-ERROR-DATE
           MOVE FUNCTION CURRENT-TIME TO WS-ERROR-TIME
           MOVE IN-CUSTOMER-ID TO WS-ERROR-CUSTOMER-ID
           MOVE WS-INPUT-STATUS TO WS-ERROR-STATUS
           
           *> エラーログファイルへの書き込み
           WRITE ERROR-LOG-RECORD
           IF WS-ERROR-LOG-STATUS NOT = "00"
               DISPLAY "エラーログ書き込みエラー: " WS-ERROR-LOG-STATUS
           END-IF.
```

### 例外処理
```cobol
       EXCEPTION-HANDLING.
           *> 予期しないエラーの処理
           DISPLAY "予期しないエラーが発生しました"
           DISPLAY "エラーコード: " WS-ERROR-CODE
           DISPLAY "エラーメッセージ: " WS-ERROR-MESSAGE
           
           *> クリーンアップ処理
           PERFORM CLEANUP-RESOURCES
           
           *> エラー終了コードの設定
           MOVE 9999 TO LS-RETURN-CODE.
```

## パフォーマンス最適化

### 効率的なデータ処理
```cobol
       OPTIMIZED-PROCESSING.
           *> バッチ処理の実装
           PERFORM UNTIL WS-END-OF-FILE
               PERFORM READ-BATCH-RECORDS
               PERFORM PROCESS-BATCH
               PERFORM WRITE-BATCH-RESULTS
           END-PERFORM
           
           *> メモリ使用量の最適化
           PERFORM CLEAR-WORKING-STORAGE
           PERFORM REINITIALIZE-VARIABLES.
```

### 並列処理の考慮
```cobol
       PARALLEL-PROCESSING.
           *> 複数ファイルの並列処理
           PERFORM PROCESS-FILE-1 IN PARALLEL
           PERFORM PROCESS-FILE-2 IN PARALLEL
           
           *> 結果の統合
           PERFORM MERGE-RESULTS.
```

## ベストプラクティス

### 1. 構造化プログラミング
- 明確なDIVISION分け
- 論理的な処理の流れ
- 適切なサブルーチン分割

### 2. エラーハンドリング
- 包括的なエラー処理
- 適切なログ記録
- クリーンアップ処理

### 3. 保守性の向上
- 意味のある名前の使用
- 適切なコメント
- 一貫したコーディング規約

### 4. パフォーマンス
- 効率的なアルゴリズム
- 適切なデータ構造
- リソースの最適化

## まとめ

COBOLのプログラム構造は、業務処理の複雑さを管理しやすくする設計になっています。適切な構造化とモジュール化により、保守性の高いプログラムを作成できます。
