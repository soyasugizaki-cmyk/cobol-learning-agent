# COBOLのファイル操作

## 概要

COBOLは、業務処理における大量データの入出力処理に特化した言語です。ファイル操作は、COBOLプログラムの重要な要素の一つです。

## ファイル編成の種類

### 1. SEQUENTIAL（順編成）
- レコードが物理的に順番に格納
- 先頭から順次読み書き
- 最も基本的で高速な処理

### 2. INDEXED（索引編成）
- キーフィールドによる高速アクセス
- 順次・ランダム両方のアクセスが可能
- データベース的な機能

### 3. RELATIVE（相対編成）
- レコード番号による直接アクセス
- 固定長レコードに適している
- 配列的なアクセス

## ファイル定義

### ENVIRONMENT DIVISIONでの定義
```cobol
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT INPUT-FILE ASSIGN TO "input.dat"
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE  IS SEQUENTIAL
               FILE STATUS  IS WS-INPUT-STATUS.
               
           SELECT OUTPUT-FILE ASSIGN TO "output.dat"
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE  IS SEQUENTIAL
               FILE STATUS  IS WS-OUTPUT-STATUS.
```

### DATA DIVISIONでの定義
```cobol
       DATA DIVISION.
       FILE SECTION.
       FD  INPUT-FILE
           RECORD CONTAINS 80 CHARACTERS
           RECORDING MODE IS FIXED.
       01  INPUT-RECORD.
           05  IN-CUSTOMER-ID    PIC 9(8).
           05  IN-CUSTOMER-NAME  PIC X(30).
           05  IN-AMOUNT         PIC 9(7)V99.
           05  FILLER            PIC X(33).

       FD  OUTPUT-FILE
           RECORD CONTAINS 100 CHARACTERS
           RECORDING MODE IS FIXED.
       01  OUTPUT-RECORD.
           05  OUT-CUSTOMER-ID   PIC 9(8).
           05  OUT-CUSTOMER-NAME PIC X(30).
           05  OUT-AMOUNT        PIC 9(7)V99.
           05  OUT-CALC-AMOUNT   PIC 9(7)V99.
           05  FILLER            PIC X(47).
```

## 基本的なファイル操作

### ファイルのオープン
```cobol
       PROCEDURE DIVISION.
           *> 入力ファイルをオープン
           OPEN INPUT INPUT-FILE
           IF WS-INPUT-STATUS NOT = "00"
               DISPLAY "入力ファイルオープンエラー: " WS-INPUT-STATUS
               STOP RUN
           END-IF
           
           *> 出力ファイルをオープン
           OPEN OUTPUT OUTPUT-FILE
           IF WS-OUTPUT-STATUS NOT = "00"
               DISPLAY "出力ファイルオープンエラー: " WS-OUTPUT-STATUS
               CLOSE INPUT-FILE
               STOP RUN
           END-IF
```

### ファイルのクローズ
```cobol
           *> ファイルのクローズ
           CLOSE INPUT-FILE
           CLOSE OUTPUT-FILE
           
           *> クローズ時のステータスチェック
           IF WS-INPUT-STATUS NOT = "00"
               DISPLAY "入力ファイルクローズエラー: " WS-INPUT-STATUS
           END-IF
           
           IF WS-OUTPUT-STATUS NOT = "00"
               DISPLAY "出力ファイルクローズエラー: " WS-OUTPUT-STATUS
           END-IF
```

## 順編成ファイルの処理

### 読み込み処理
```cobol
           *> ファイル終端まで読み込み
           PERFORM UNTIL WS-EOF = "Y"
               READ INPUT-FILE
                   AT END
                       MOVE "Y" TO WS-EOF
                   NOT AT END
                       PERFORM PROCESS-RECORD
               END-READ
               
               *> ファイルステータスのチェック
               IF WS-INPUT-STATUS NOT = "00" AND WS-INPUT-STATUS NOT = "10"
                   DISPLAY "読み込みエラー: " WS-INPUT-STATUS
                   MOVE "Y" TO WS-EOF
               END-IF
           END-PERFORM
```

### 書き込み処理
```cobol
           *> レコードの書き込み
           MOVE IN-CUSTOMER-ID TO OUT-CUSTOMER-ID
           MOVE IN-CUSTOMER-NAME TO OUT-CUSTOMER-NAME
           MOVE IN-AMOUNT TO OUT-AMOUNT
           
           *> 計算処理
           COMPUTE OUT-CALC-AMOUNT = IN-AMOUNT * 1.1
               ON SIZE ERROR
                   DISPLAY "計算エラー: 桁あふれ"
                   MOVE 0 TO OUT-CALC-AMOUNT
           END-COMPUTE
           
           *> ファイルへの書き込み
           WRITE OUTPUT-RECORD
           IF WS-OUTPUT-STATUS NOT = "00"
               DISPLAY "書き込みエラー: " WS-OUTPUT-STATUS
           END-IF
```

## 索引編成ファイルの処理

### ファイル定義
```cobol
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT CUSTOMER-FILE ASSIGN TO "customer.dat"
               ORGANIZATION IS INDEXED
               ACCESS MODE  IS RANDOM
               RECORD KEY   IS CUSTOMER-ID
               FILE STATUS  IS WS-CUSTOMER-STATUS.
```

### ランダムアクセス
```cobol
           *> 特定のレコードの読み込み
           MOVE 12345 TO CUSTOMER-ID
           READ CUSTOMER-FILE
               INVALID KEY
                   DISPLAY "レコードが見つかりません: " CUSTOMER-ID
               NOT INVALID KEY
                   PERFORM PROCESS-CUSTOMER
           END-READ
```

### 順次アクセス
```cobol
           *> 索引順での読み込み
           START CUSTOMER-FILE
               KEY IS GREATER THAN CUSTOMER-ID
               INVALID KEY
                   DISPLAY "開始位置が見つかりません"
           END-START
           
           PERFORM UNTIL WS-EOF = "Y"
               READ CUSTOMER-FILE NEXT
                   AT END
                       MOVE "Y" TO WS-EOF
                   NOT AT END
                       PERFORM PROCESS-CUSTOMER
               END-READ
           END-PERFORM
```

## ファイルステータス

### 主要なステータスコード
- `"00"` - 正常終了
- `"10"` - ファイル終端
- `"23"` - レコードが見つからない
- `"30"` - ファイルが存在しない
- `"35"` - ファイルが存在しない（OPEN OUTPUT）
- `"37"` - ファイルが存在しない（OPEN EXTEND）
- `"39"` - ファイルが存在しない（OPEN I-O）
- `"41"` - ファイルが既にオープンされている
- `"42"` - ファイルがオープンされていない
- `"43"` - ファイルがオープンされていない（CLOSE）
- `"44"` - ファイルがオープンされていない（READ/WRITE）
- `"46"` - ファイルがオープンされていない（REWRITE/DELETE）
- `"47"` - ファイルがオープンされていない（START）
- `"48"` - ファイルがオープンされていない（OPEN I-O）
- `"49"` - ファイルがオープンされていない（OPEN EXTEND）

### ステータスチェックの実装
```cobol
       01  WS-FILE-STATUS-CHECK.
           05  WS-STATUS        PIC XX.
           05  WS-STATUS-MESSAGE PIC X(50).

       *> ステータスチェック処理
           EVALUATE WS-STATUS
               WHEN "00"
                   CONTINUE
               WHEN "10"
                   MOVE "ファイル終端" TO WS-STATUS-MESSAGE
               WHEN "23"
                   MOVE "レコードが見つかりません" TO WS-STATUS-MESSAGE
               WHEN "30"
                   MOVE "ファイルが存在しません" TO WS-STATUS-MESSAGE
               WHEN OTHER
                   MOVE "その他のエラー" TO WS-STATUS-MESSAGE
           END-EVALUATE
           
           IF WS-STATUS NOT = "00" AND WS-STATUS NOT = "10"
               DISPLAY "ファイルエラー: " WS-STATUS-MESSAGE
           END-IF
```

## エラーハンドリング

### ファイルエラーの処理
```cobol
           *> ファイルオープン時のエラー処理
           OPEN INPUT INPUT-FILE
           IF WS-INPUT-STATUS NOT = "00"
               PERFORM FILE-ERROR-HANDLING
               STOP RUN
           END-IF
           
       *> ファイルエラー処理ルーチン
       FILE-ERROR-HANDLING.
           EVALUATE WS-INPUT-STATUS
               WHEN "30"
                   DISPLAY "入力ファイルが存在しません"
               WHEN "41"
                   DISPLAY "ファイルが既にオープンされています"
               WHEN OTHER
                   DISPLAY "予期しないエラー: " WS-INPUT-STATUS
           END-EVALUATE
```

### データエラーの処理
```cobol
           *> データ読み込み時のエラー処理
           READ INPUT-FILE
           IF WS-INPUT-STATUS NOT = "00" AND WS-INPUT-STATUS NOT = "10"
               PERFORM DATA-ERROR-HANDLING
           END-IF
           
       *> データエラー処理ルーチン
       DATA-ERROR-HANDLING.
           DISPLAY "データ読み込みエラー: " WS-INPUT-STATUS
           *> エラーログの記録
           *> 代替データの設定
           *> 処理の継続判断
```

## ファイルの更新

### 読み書きモードでのオープン
```cobol
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT UPDATE-FILE ASSIGN TO "update.dat"
               ORGANIZATION IS INDEXED
               ACCESS MODE  IS RANDOM
               RECORD KEY   IS RECORD-ID
               FILE STATUS  IS WS-UPDATE-STATUS.
```

### レコードの更新
```cobol
           *> レコードの読み込み
           READ UPDATE-FILE
               INVALID KEY
                   DISPLAY "更新対象レコードが見つかりません"
               NOT INVALID KEY
                   *> データの更新
                   MOVE NEW-VALUE TO RECORD-FIELD
                   
                   *> 更新されたレコードの書き込み
                   REWRITE RECORD
                   IF WS-UPDATE-STATUS NOT = "00"
                       DISPLAY "更新エラー: " WS-UPDATE-STATUS
                   END-IF
           END-READ
```

### レコードの削除
```cobol
           *> レコードの削除
           DELETE UPDATE-FILE
               INVALID KEY
                   DISPLAY "削除対象レコードが見つかりません"
               NOT INVALID KEY
                   DISPLAY "レコードを削除しました"
           END-DELETE
```

## ファイルの結合

### 複数ファイルの処理
```cobol
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT MASTER-FILE ASSIGN TO "master.dat"
               ORGANIZATION IS INDEXED
               ACCESS MODE  IS RANDOM
               RECORD KEY   IS MASTER-KEY
               FILE STATUS  IS WS-MASTER-STATUS.
               
           SELECT TRANSACTION-FILE ASSIGN TO "trans.dat"
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE  IS SEQUENTIAL
               FILE STATUS  IS WS-TRANS-STATUS.
               
           SELECT OUTPUT-FILE ASSIGN TO "output.dat"
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE  IS SEQUENTIAL
               FILE STATUS  IS WS-OUTPUT-STATUS.
```

### マッチング処理
```cobol
           *> マスタファイルの読み込み
           READ MASTER-FILE
               INVALID KEY
                   MOVE SPACES TO MASTER-RECORD
               NOT INVALID KEY
                   CONTINUE
           END-READ
           
           *> トランザクションファイルの処理
           PERFORM UNTIL WS-TRANS-EOF = "Y"
               READ TRANSACTION-FILE
                   AT END
                       MOVE "Y" TO WS-TRANS-EOF
                   NOT AT END
                       PERFORM MATCH-PROCESSING
               END-READ
           END-PERFORM
```

## ベストプラクティス

### 1. ファイルステータスの確認
- すべてのファイル操作後にステータスチェック
- 適切なエラーハンドリングの実装
- エラーログの記録

### 2. ファイルの適切な管理
- 必要最小限のファイルオープン
- 適切なタイミングでのファイルクローズ
- リソースの効率的な使用

### 3. データの整合性
- トランザクション処理の実装
- ロールバック機能の提供
- データ検証の徹底

### 4. パフォーマンスの最適化
- 適切なファイル編成の選択
- バッファサイズの最適化
- インデックスの適切な設計

## まとめ

COBOLのファイル操作は、業務処理における大量データの効率的な処理を実現します。適切な設計と実装により、信頼性の高いファイル処理プログラムを作成できます。
